# Choomi（啾米）MVP系统设计文档（SDD）

## 1. 文档控制信息
- 项目名称：Choomi（啾米）桌面宠物MVP
- 版本号：V1.1
- 作者：项目负责人
- 创建日期：2024-xx-xx
- 修订记录：
  - V1.0 初版
  - V1.1 增加平台系统与通讯接口设计

## 2. 系统架构设计
### 2.1 整体架构图
- 设备端（ESP32）：LCD动画显示、麦克风采集、扬声器播放、Wi-Fi联网
- 平台服务（本地PC）：API网关、会话管理、大模型适配器、日志监控
- 本地大模型API（如Ollama/Qwen）：标准RESTful接口

```
[ESP32设备] ←→ [平台服务API] ←→ [本地大模型API]
```

### 2.2 部署架构
- 设备端通过Wi-Fi连接本地PC平台服务
- 平台服务与本地大模型API（如Ollama）通过HTTP本地调用

### 2.3 数据架构
- 设备与平台服务间采用JSON协议，支持音频/文本消息、状态同步
- 平台服务与大模型API间采用标准RESTful接口

## 3. 技术方案说明
### 3.1 技术选型
- 设备端：ESP-IDF（C/C++），I2S驱动，Wi-Fi SDK
- 平台服务：Python（FastAPI）、WebSocket/HTTP、requests库
- 大模型API：Ollama本地部署Qwen，RESTful接口

### 3.2 框架设计
- 平台服务采用分层架构：API层、业务逻辑层、模型适配层
- 支持多设备并发接入与会话隔离

### 3.3 通讯接口规范
#### 设备端 ←→ 平台服务
- POST /ask
  - 请求体：
    ```json
    {"device_id": "string", "msg_type": "audio/text", "content": "base64/文本", "timestamp": 1234567890}
    ```
  - 响应体：
    ```json
    {"code": 0, "msg": "ok", "reply": "文本"}
    ```
- 支持WebSocket长连接，便于实时推送

#### 平台服务 ←→ 大模型API（Ollama）
- POST /api/chat
  - 请求体：
    ```json
    {"model": "qwen", "messages": [{"role": "user", "content": "..."}]}
    ```
  - 响应体：
    ```json
    {"response": "模型回复"}
    ```

### 3.4 鉴权与安全
- 设备端每次请求需携带唯一device_id
- 平台服务可校验白名单/Token
- 本地通信可选用HTTP，生产环境建议HTTPS

## 4. 详细设计
### 4.1 端到端流程
1. 设备端采集音频或文本，POST至平台服务/ask接口
2. 平台服务如需ASR，先转文本，否则直接转发至大模型API
3. 获取大模型回复后，平台服务返回设备端
4. 设备端TTS合成语音并播放，或LCD显示文本

### 4.2 核心模块说明
- **API网关**：统一接收设备请求，路由分发
- **会话管理**：维护设备会话状态，支持多轮对话
- **大模型适配器**：对接Ollama API，支持模型切换
- **日志与监控**：记录交互日志，异常报警

### 4.3 数据结构与接口字段
- 详见3.3通讯接口规范

## 5. 数据库设计（如需持久化）
- 可选用SQLite/MongoDB，存储设备信息、会话日志

## 6. 安全方案
- 设备身份认证、接口限流、日志审计

## 7. 性能设计
- 支持并发10台设备接入，单轮响应延迟<2s

## 8. 容灾备份方案
- 平台服务支持自动重启，日志定期备份

## 9. 质量保障
- 单元测试、接口联调、端到端集成测试

## 10. 附录
- 术语表、参考资料、接口文档链接