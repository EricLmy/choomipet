# ä»»åŠ¡10: è®¾å¤‡æ³¨å†Œä¸èº«ä»½éªŒè¯å®ç°ï¼ˆå¯é€‰ï¼‰

- [ ] 10. è®¾å¤‡æ³¨å†Œä¸èº«ä»½éªŒè¯å®ç°ï¼ˆå¯é€‰ï¼‰
  - [ ] 10.1 å®ç°è®¾å¤‡å”¯ä¸€IDç”Ÿæˆå’Œç®¡ç†
    - ç¼–å†™åŸºäºMACåœ°å€çš„è®¾å¤‡IDç”Ÿæˆä»£ç 
    - å®ç°è®¾å¤‡ä¿¡æ¯æ”¶é›†å’Œå”¯ä¸€ç è®¡ç®—
    - æ·»åŠ è®¾å¤‡IDçš„åŠ å¯†å­˜å‚¨å’ŒéªŒè¯
    - åˆ›å»ºè®¾å¤‡æ ‡è¯†çš„å®‰å…¨ç®¡ç†æœºåˆ¶
    - _éœ€æ±‚: 9.1, 9.3, 9.5_

    **å¼€å‘å‰ææ¡ä»¶ï¼š**
    - âœ… ä»»åŠ¡9è®¾å¤‡çŠ¶æ€ç®¡ç†ç³»ç»Ÿå·²å®Œæˆ
    - âœ… NVSåŠ å¯†å­˜å‚¨åŠŸèƒ½å·²é…ç½®
    - âœ… åŠ å¯†ç®—æ³•åº“å·²é›†æˆ

    **å¿…éœ€å‡†å¤‡ææ–™ï¼š**
    - ğŸ“‹ è®¾å¤‡IDç”Ÿæˆç®—æ³•è§„èŒƒ
    - ğŸ“‹ åŠ å¯†å­˜å‚¨å®‰å…¨ç­–ç•¥
    - ğŸ“‹ è®¾å¤‡æ³¨å†Œåè®®æ–‡æ¡£
    - ğŸ“‹ èº«ä»½éªŒè¯æµç¨‹å›¾
    - ğŸ“‹ å®‰å…¨å¯†é’¥ç®¡ç†æ–¹æ¡ˆ

    **å…·ä½“å®ç°å†…å®¹ï¼š**
    ```c
    // components/system/device_auth.h
    typedef struct {
        char device_id[64];
        char device_secret[128];
        char access_token[128];
        char refresh_token[128];
        uint64_t token_expire_time;
        bool registered;
    } device_auth_t;

    esp_err_t device_auth_init(auth_config_t *config);
    esp_err_t device_auth_generate_id(char *device_id, size_t size);
    
    // components/system/device_auth.c
    esp_err_t device_auth_generate_id(char *device_id, size_t size) {
        uint8_t mac[6];
        esp_wifi_get_mac(WIFI_IF_STA, mac);
        
        // è·å–èŠ¯ç‰‡ID
        uint32_t chip_id = 0;
        for (int i = 0; i < 17; i = i + 8) {
            chip_id |= ((esp_efuse_get_field_value(ESP_EFUSE_MAC_FACTORY_CRC) >> i) & 0xff) << (16 - i);
        }
        
        // ç”Ÿæˆè®¾å¤‡å”¯ä¸€ç 
        char temp_id[128];
        snprintf(temp_id, sizeof(temp_id), "%02X%02X%02X%02X%02X%02X-%08X-%s-%s",
                 mac[0], mac[1], mac[2], mac[3], mac[4], mac[5],
                 chip_id, "CHOOMI", "V1.0");
        
        // SHA256å“ˆå¸Œ
        uint8_t hash[32];
        mbedtls_sha256((uint8_t*)temp_id, strlen(temp_id), hash, 0);
        
        // æ ¼å¼åŒ–ä¸ºæ ‡å‡†è®¾å¤‡ID
        snprintf(device_id, size, "CHOOMI-%02X%02X%02X%02X-%02X%02X-%02X%02X-%02X%02X-%02X%02X%02X%02X%02X%02X",
                 hash[0], hash[1], hash[2], hash[3],
                 hash[4], hash[5], hash[6], hash[7],
                 hash[8], hash[9], hash[10], hash[11],
                 hash[12], hash[13], hash[14], hash[15]);
        
        return ESP_OK;
    }
    ```

    **è¯¦ç»†ä»»åŠ¡å†…å®¹ï¼š**
    - åˆ›å»ºdevice_auth.hå®šä¹‰è®¾å¤‡è®¤è¯æ¥å£å’Œæ•°æ®ç»“æ„
    - å®ç°device_auth.cåŒ…å«è®¾å¤‡IDç”Ÿæˆå’Œç®¡ç†å‡½æ•°
    - å®ç°è®¾å¤‡IDç”Ÿæˆï¼šåŸºäºMACåœ°å€+è®¾å¤‡å‹å·+ç”Ÿäº§æ‰¹æ¬¡+éšæœºç§å­çš„SHA256å“ˆå¸Œ
    - åˆ›å»ºè®¾å¤‡ä¿¡æ¯æ”¶é›†ï¼šè·å–MACåœ°å€ã€èŠ¯ç‰‡IDã€å›ºä»¶ç‰ˆæœ¬ç­‰ç¡¬ä»¶ä¿¡æ¯
    - å®ç°è®¾å¤‡IDæ ¼å¼åŒ–ï¼šç”Ÿæˆ"CHOOMI-XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX"æ ¼å¼
    - æ·»åŠ AES-256åŠ å¯†å­˜å‚¨ï¼šå°†è®¾å¤‡IDå’Œå¯†é’¥å®‰å…¨å­˜å‚¨åˆ°NVS
    - å®ç°è®¾å¤‡IDéªŒè¯ï¼šå¯åŠ¨æ—¶éªŒè¯å­˜å‚¨çš„è®¾å¤‡IDæœ‰æ•ˆæ€§
    - åˆ›å»ºè®¾å¤‡æ ‡è¯†ç®¡ç†ï¼šæ”¯æŒè®¾å¤‡IDæŸ¥è¯¢ã€æ›´æ–°ã€é‡ç½®ç­‰æ“ä½œ

    **éªŒæ”¶æ ‡å‡†ï¼š**
    - è®¾å¤‡IDç”Ÿæˆç®—æ³•ç¨³å®šï¼Œç›¸åŒç¡¬ä»¶ç”Ÿæˆç›¸åŒID
    - è®¾å¤‡IDæ ¼å¼ç¬¦åˆè§„èŒƒï¼Œé•¿åº¦å’Œæ ¼å¼æ­£ç¡®
    - è®¾å¤‡ä¿¡æ¯æ”¶é›†å®Œæ•´ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„ç¡¬ä»¶æ ‡è¯†
    - AESåŠ å¯†å­˜å‚¨å®‰å…¨å¯é ï¼Œé‡å¯åèƒ½å¤Ÿæ­£ç¡®è§£å¯†è¯»å–
    - è®¾å¤‡IDéªŒè¯æœºåˆ¶æœ‰æ•ˆï¼Œèƒ½å¤Ÿæ£€æµ‹IDç¯¡æ”¹æˆ–æŸå
    - è®¾å¤‡æ ‡è¯†ç®¡ç†åŠŸèƒ½å®Œæ•´ï¼Œæ”¯æŒå„ç§æ“ä½œåœºæ™¯

  - [ ] 10.2 å®ç°è®¾å¤‡æ³¨å†Œå’ŒæœåŠ¡å™¨é€šä¿¡
    - ç¼–å†™è®¾å¤‡æ³¨å†Œè¯·æ±‚å’Œå“åº”å¤„ç†ä»£ç 
    - å®ç°HTTPSå®‰å…¨é€šä¿¡å’Œè¯ä¹¦éªŒè¯
    - æ·»åŠ æ³¨å†ŒçŠ¶æ€ç®¡ç†å’Œé”™è¯¯å¤„ç†
    - åˆ›å»ºæ³¨å†Œæµç¨‹çš„ç”¨æˆ·ç•Œé¢å’Œæç¤º
    - _éœ€æ±‚: 9.2, 9.4, 9.9_

    **å¼€å‘å‰ææ¡ä»¶ï¼š**
    - âœ… ä»»åŠ¡10.1 è®¾å¤‡å”¯ä¸€IDç”Ÿæˆå’Œç®¡ç†å·²å®Œæˆ
    - âœ… HTTPSå®¢æˆ·ç«¯åº“å·²é›†æˆ
    - âœ… æœåŠ¡å™¨æ³¨å†Œæ¥å£å·²ç¡®è®¤

    **å¿…éœ€å‡†å¤‡ææ–™ï¼š**
    - ğŸ“‹ è®¾å¤‡æ³¨å†ŒAPIæ–‡æ¡£
    - ğŸ“‹ HTTPSé€šä¿¡å®‰å…¨è§„èŒƒ
    - ğŸ“‹ è¯ä¹¦éªŒè¯æµç¨‹
    - ğŸ“‹ æ³¨å†Œç•Œé¢è®¾è®¡ç¨¿
    - ğŸ“‹ é”™è¯¯å¤„ç†ç­–ç•¥

    **è¯¦ç»†ä»»åŠ¡å†…å®¹ï¼š**
    - åˆ›å»ºdevice_register.hå®šä¹‰æ³¨å†Œæ¥å£å’ŒçŠ¶æ€æšä¸¾
    - å®ç°device_register.cåŒ…å«è®¾å¤‡æ³¨å†Œå’Œé€šä¿¡å‡½æ•°
    - å®ç°HTTPSå®¢æˆ·ç«¯ï¼šæ”¯æŒTLS 1.2/1.3ï¼Œè¯ä¹¦é“¾éªŒè¯
    - åˆ›å»ºæ³¨å†Œè¯·æ±‚ï¼šåŒ…å«è®¾å¤‡IDã€ç¡¬ä»¶ä¿¡æ¯ã€å›ºä»¶ç‰ˆæœ¬ç­‰
    - å®ç°æ³¨å†Œå“åº”å¤„ç†ï¼šè§£ææœåŠ¡å™¨è¿”å›çš„æ³¨å†ŒçŠ¶æ€å’Œè®¿é—®ä»¤ç‰Œ
    - æ·»åŠ æ³¨å†ŒçŠ¶æ€ç®¡ç†ï¼šæœªæ³¨å†Œã€æ³¨å†Œä¸­ã€å·²æ³¨å†Œã€æ³¨å†Œå¤±è´¥ç­‰çŠ¶æ€
    - å®ç°æ³¨å†Œé‡è¯•æœºåˆ¶ï¼šæŒ‡æ•°é€€é¿ç®—æ³•ï¼Œæœ€å¤§é‡è¯•3æ¬¡
    - åˆ›å»ºæ³¨å†Œç•Œé¢ï¼šLCDæ˜¾ç¤ºæ³¨å†Œè¿›åº¦ï¼ŒRGB LEDæŒ‡ç¤ºæ³¨å†ŒçŠ¶æ€

    **éªŒæ”¶æ ‡å‡†ï¼š**
    - HTTPSé€šä¿¡å®‰å…¨å¯é ï¼Œæ”¯æŒè¯ä¹¦éªŒè¯å’ŒåŠ å¯†ä¼ è¾“
    - æ³¨å†Œè¯·æ±‚æ ¼å¼æ­£ç¡®ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„è®¾å¤‡ä¿¡æ¯
    - æ³¨å†Œå“åº”å¤„ç†å‡†ç¡®ï¼Œèƒ½å¤Ÿæ­£ç¡®è§£ææœåŠ¡å™¨è¿”å›æ•°æ®
    - æ³¨å†ŒçŠ¶æ€ç®¡ç†å®Œæ•´ï¼ŒçŠ¶æ€è½¬æ¢é€»è¾‘æ­£ç¡®
    - æ³¨å†Œé‡è¯•æœºåˆ¶æ™ºèƒ½ï¼Œé¿å…é¢‘ç¹è¯·æ±‚é€ æˆæœåŠ¡å™¨å‹åŠ›
    - æ³¨å†Œç•Œé¢å‹å¥½ï¼Œç”¨æˆ·èƒ½å¤Ÿæ¸…æ¥šäº†è§£æ³¨å†Œè¿›åº¦å’ŒçŠ¶æ€

  - [ ] 10.3 å®ç°èº«ä»½éªŒè¯å’Œä»¤ç‰Œç®¡ç†
    - ç¼–å†™è®¿é—®ä»¤ç‰Œçš„è·å–å’Œåˆ·æ–°ä»£ç 
    - å®ç°æ¶ˆæ¯ç­¾åéªŒè¯å’Œå®‰å…¨æ£€æŸ¥
    - æ·»åŠ ä»¤ç‰Œè¿‡æœŸå¤„ç†å’Œè‡ªåŠ¨æ›´æ–°
    - åˆ›å»ºèº«ä»½éªŒè¯å¤±è´¥çš„å®‰å…¨å“åº”
    - _éœ€æ±‚: 9.6, 9.7, 9.8, 9.10_

    **å¼€å‘å‰ææ¡ä»¶ï¼š**
    - âœ… ä»»åŠ¡10.2 è®¾å¤‡æ³¨å†Œå’ŒæœåŠ¡å™¨é€šä¿¡å·²å®Œæˆ
    - âœ… JWTä»¤ç‰Œå¤„ç†åº“å·²é›†æˆ
    - âœ… æ¶ˆæ¯ç­¾åç®—æ³•å·²ç¡®è®¤

    **å¿…éœ€å‡†å¤‡ææ–™ï¼š**
    - ğŸ“‹ JWTä»¤ç‰Œæ ¼å¼è§„èŒƒ
    - ğŸ“‹ æ¶ˆæ¯ç­¾åç®—æ³•æ–‡æ¡£
    - ğŸ“‹ ä»¤ç‰Œåˆ·æ–°æœºåˆ¶è®¾è®¡
    - ğŸ“‹ å®‰å…¨å“åº”ç­–ç•¥
    - ğŸ“‹ èº«ä»½éªŒè¯æµ‹è¯•ç”¨ä¾‹

    **è¯¦ç»†ä»»åŠ¡å†…å®¹ï¼š**
    - åˆ›å»ºtoken_manager.hå®šä¹‰ä»¤ç‰Œç®¡ç†æ¥å£å’Œå®‰å…¨æœºåˆ¶
    - å®ç°token_manager.cåŒ…å«ä»¤ç‰Œè·å–ã€åˆ·æ–°å’ŒéªŒè¯å‡½æ•°
    - å®ç°è®¿é—®ä»¤ç‰Œè·å–ï¼šæ³¨å†ŒæˆåŠŸåä»æœåŠ¡å™¨è·å–JWTä»¤ç‰Œ
    - åˆ›å»ºä»¤ç‰Œåˆ·æ–°æœºåˆ¶ï¼šä»¤ç‰Œè¿‡æœŸå‰è‡ªåŠ¨åˆ·æ–°ï¼Œæ”¯æŒrefresh token
    - å®ç°æ¶ˆæ¯ç­¾åï¼šä½¿ç”¨HMAC-SHA256å¯¹WebSocketæ¶ˆæ¯è¿›è¡Œç­¾å
    - æ·»åŠ ç­¾åéªŒè¯ï¼šéªŒè¯æœåŠ¡å™¨æ¶ˆæ¯çš„æ•°å­—ç­¾åï¼Œé˜²æ­¢ä¼ªé€ æ”»å‡»
    - å®ç°ä»¤ç‰Œè¿‡æœŸå¤„ç†ï¼šæ£€æµ‹ä»¤ç‰Œè¿‡æœŸï¼Œè‡ªåŠ¨é‡æ–°è®¤è¯
    - åˆ›å»ºå®‰å…¨å“åº”ï¼šè®¤è¯å¤±è´¥æ—¶è®°å½•æ—¥å¿—ï¼Œæ‹’ç»æ‰§è¡ŒæŒ‡ä»¤ï¼Œé€šçŸ¥ç”¨æˆ·

    **éªŒæ”¶æ ‡å‡†ï¼š**
    - è®¿é—®ä»¤ç‰Œè·å–æˆåŠŸï¼Œæ ¼å¼ç¬¦åˆJWTæ ‡å‡†
    - ä»¤ç‰Œåˆ·æ–°æœºåˆ¶å¯é ï¼Œèƒ½å¤Ÿåœ¨è¿‡æœŸå‰è‡ªåŠ¨æ›´æ–°
    - æ¶ˆæ¯ç­¾åç®—æ³•æ­£ç¡®ï¼Œç­¾åéªŒè¯é€šè¿‡ç‡100%
    - ç­¾åéªŒè¯æœºåˆ¶æœ‰æ•ˆï¼Œèƒ½å¤Ÿæ£€æµ‹å’Œæ‹’ç»ä¼ªé€ æ¶ˆæ¯
    - ä»¤ç‰Œè¿‡æœŸå¤„ç†åŠæ—¶ï¼Œä¸ä¼šå› è¿‡æœŸä»¤ç‰Œå¯¼è‡´é€šä¿¡ä¸­æ–­
    - å®‰å…¨å“åº”æœºåˆ¶å®Œå–„ï¼Œè®¤è¯å¤±è´¥æ—¶èƒ½å¤Ÿæ­£ç¡®å¤„ç†å’Œæç¤º