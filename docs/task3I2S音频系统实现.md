# ä»»åŠ¡3: I2SéŸ³é¢‘ç³»ç»Ÿå®ç°

- [ ] 3. I2SéŸ³é¢‘ç³»ç»Ÿå®ç°
  - [ ] 3.1 å®ç°I2Sé©±åŠ¨åŸºç¡€æ¡†æ¶
    - ç¼–å†™I2Sæ§åˆ¶å™¨é…ç½®å’Œåˆå§‹åŒ–ä»£ç 
    - å®ç°I2Sæ—¶é’Ÿé…ç½®å’ŒåŒæ­¥æœºåˆ¶
    - åˆ›å»ºéŸ³é¢‘æ•°æ®ç¼“å†²åŒºç®¡ç†
    - _éœ€æ±‚: 4.2, 5.2_
    - _å¯¹åº”ä¸»ç¨‹åº: audio_processing_task()ä¸­çš„éŸ³é¢‘å¤„ç†æµç¨‹_

    **å¼€å‘å‰ææ¡ä»¶ï¼š**
    - âœ… ä»»åŠ¡2ç¡¬ä»¶åˆå§‹åŒ–å’ŒGPIOé…ç½®å·²å®Œæˆ
    - âœ… INMP441éº¦å…‹é£æ¨¡å—å·²è¿æ¥åˆ°å¼€å‘æ¿
    - âœ… MAX98357AåŠŸæ”¾æ¨¡å—å·²è¿æ¥åˆ°å¼€å‘æ¿
    - âœ… ç¤ºæ³¢å™¨æˆ–é€»è¾‘åˆ†æä»ªï¼ˆç”¨äºI2Sä¿¡å·æµ‹è¯•ï¼‰

    **å¿…éœ€å‡†å¤‡ææ–™ï¼š**
    - ğŸ“‹ I2Såè®®è§„èŒƒæ–‡æ¡£
    - ğŸ“‹ INMP441æ•°æ®æ‰‹å†Œ
    - ğŸ“‹ MAX98357Aæ•°æ®æ‰‹å†Œ
    - ğŸ“‹ éŸ³é¢‘ç¼“å†²åŒºè®¾è®¡æ–¹æ¡ˆ
    - ğŸ“‹ I2Sæ—¶é’Ÿé…ç½®å‚æ•°è¡¨
    - ğŸ“‹ DMAé…ç½®å‚æ•°è¡¨

    **å…·ä½“å®ç°å†…å®¹ï¼ˆåŸºäºä¸»ç¨‹åºè®¾è®¡ï¼‰ï¼š**
    ```c
    // components/audio/i2s_driver.h
    #define AUDIO_SAMPLE_RATE    16000
    #define AUDIO_BITS_PER_SAMPLE 16
    #define AUDIO_BUFFER_SIZE    1024
    #define I2S_NUM_0           I2S_NUM_0  // éº¦å…‹é£
    #define I2S_NUM_1           I2S_NUM_1  // æ‰¬å£°å™¨

    typedef struct {
        i2s_port_t port;
        uint32_t sample_rate;
        uint8_t bits_per_sample;
        i2s_channel_fmt_t channel_format;
        size_t buffer_size;
        QueueHandle_t audio_queue;
    } i2s_config_choomi_t;

    esp_err_t i2s_driver_init(void);
    
    // components/audio/i2s_driver.c
    esp_err_t i2s_driver_init(void) {
        // I2S0é…ç½®ï¼ˆéº¦å…‹é£è¾“å…¥ï¼‰
        i2s_config_t i2s_config_mic = {
            .mode = I2S_MODE_MASTER | I2S_MODE_RX,
            .sample_rate = AUDIO_SAMPLE_RATE,
            .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,
            .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT,
            .communication_format = I2S_COMM_FORMAT_STAND_I2S,
            .intr_alloc_flags = ESP_INTR_FLAG_LEVEL2,
            .dma_buf_count = 4,
            .dma_buf_len = 1024,
            .use_apll = false,
            .tx_desc_auto_clear = false,
            .fixed_mclk = 0
        };

        i2s_pin_config_t pin_config_mic = {
            .bck_io_num = I2S_BCLK_PIN,
            .ws_io_num = I2S_WS_PIN,
            .data_out_num = I2S_PIN_NO_CHANGE,
            .data_in_num = I2S_DIN_PIN
        };

        ESP_ERROR_CHECK(i2s_driver_install(I2S_NUM_0, &i2s_config_mic, 0, NULL));
        ESP_ERROR_CHECK(i2s_set_pin(I2S_NUM_0, &pin_config_mic));

        // I2S1é…ç½®ï¼ˆæ‰¬å£°å™¨è¾“å‡ºï¼‰
        i2s_config_t i2s_config_spk = {
            .mode = I2S_MODE_MASTER | I2S_MODE_TX,
            .sample_rate = AUDIO_SAMPLE_RATE,
            .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,
            .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT,
            .communication_format = I2S_COMM_FORMAT_STAND_I2S,
            .intr_alloc_flags = ESP_INTR_FLAG_LEVEL2,
            .dma_buf_count = 4,
            .dma_buf_len = 1024,
            .use_apll = false,
            .tx_desc_auto_clear = true,
            .fixed_mclk = 0
        };

        i2s_pin_config_t pin_config_spk = {
            .bck_io_num = I2S_BCLK_PIN,
            .ws_io_num = I2S_WS_PIN,
            .data_out_num = I2S_DOUT_PIN,
            .data_in_num = I2S_PIN_NO_CHANGE
        };

        ESP_ERROR_CHECK(i2s_driver_install(I2S_NUM_1, &i2s_config_spk, 0, NULL));
        ESP_ERROR_CHECK(i2s_set_pin(I2S_NUM_1, &pin_config_spk));

        ESP_LOGI(TAG, "I2S driver initialized");
        return ESP_OK;
    }
    ```

    **è¯¦ç»†ä»»åŠ¡å†…å®¹ï¼š**
    - åˆ›å»ºi2s_driver.hå®šä¹‰I2Sé…ç½®ç»“æ„ä½“å’Œæ¥å£å‡½æ•°
    - å®ç°i2s_driver.cåŒ…å«I2Såˆå§‹åŒ–å’Œé…ç½®å‡½æ•°
    - é…ç½®I2S0ç”¨äºéº¦å…‹é£è¾“å…¥ï¼ŒI2S1ç”¨äºæ‰¬å£°å™¨è¾“å‡º
    - è®¾ç½®I2Sæ—¶é’Ÿï¼š16kHzé‡‡æ ·ç‡ï¼Œ16bitä½æ·±ï¼Œå•å£°é“
    - å®ç°éŸ³é¢‘ç¼“å†²åŒºç®¡ç†ï¼šç¯å½¢ç¼“å†²åŒºï¼Œæ”¯æŒDMAä¼ è¾“
    - æ·»åŠ I2Sé”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç›‘æ§
    - åˆ›å»ºéŸ³é¢‘æ•°æ®æ ¼å¼è½¬æ¢å‡½æ•°ï¼ˆPCM/WAVï¼‰

    **éªŒæ”¶æ ‡å‡†ï¼š**
    - I2Sæ§åˆ¶å™¨èƒ½å¤Ÿæ­£ç¡®åˆå§‹åŒ–å¹¶è¾“å‡º16kHzæ—¶é’Ÿä¿¡å·
    - éŸ³é¢‘ç¼“å†²åŒºèƒ½å¤Ÿç¨³å®šå·¥ä½œï¼Œæ— æ•°æ®ä¸¢å¤±æˆ–æº¢å‡º
    - I2S DMAä¼ è¾“æ­£å¸¸ï¼ŒCPUå ç”¨ç‡<20%
    - æ—¶é’ŸåŒæ­¥å‡†ç¡®ï¼ŒéŸ³é¢‘é‡‡æ ·ç‡è¯¯å·®<1%
    - é”™è¯¯å¤„ç†æœºåˆ¶èƒ½å¤Ÿæ£€æµ‹å¹¶æ¢å¤I2Sé€šä¿¡å¼‚å¸¸
    - ç³»ç»Ÿå¯åŠ¨æ—¶è¾“å‡º"I2S driver initialized"æ—¥å¿—

  - [ ] 3.2 å®ç°INMP441éº¦å…‹é£é©±åŠ¨
    - ç¼–å†™éº¦å…‹é£åˆå§‹åŒ–å’Œé…ç½®ä»£ç 
    - å®ç°16kHzé‡‡æ ·ç‡çš„éŸ³é¢‘é‡‡é›†åŠŸèƒ½
    - æ·»åŠ éŸ³é¢‘æ•°æ®æ ¼å¼è½¬æ¢å’Œç¼“å­˜æœºåˆ¶
    - åˆ›å»ºå½•éŸ³æ§åˆ¶æ¥å£ï¼ˆå¼€å§‹/åœæ­¢/æš‚åœï¼‰
    - _éœ€æ±‚: 4.1, 4.2, 4.3, 4.4_

    **å¼€å‘å‰ææ¡ä»¶ï¼š**
    - âœ… ä»»åŠ¡3.1 I2Sé©±åŠ¨åŸºç¡€æ¡†æ¶å·²å®Œæˆ
    - âœ… INMP441éº¦å…‹é£æ¨¡å—å·²æ­£ç¡®è¿æ¥å¹¶æµ‹è¯•
    - âœ… éŸ³é¢‘æµ‹è¯•è®¾å¤‡ï¼ˆæ‰¬å£°å™¨æˆ–è€³æœºï¼‰

    **å¿…éœ€å‡†å¤‡ææ–™ï¼š**
    - ğŸ“‹ INMP441è¯¦ç»†æŠ€æœ¯è§„æ ¼ä¹¦
    - ğŸ“‹ éŸ³é¢‘é‡‡é›†æµ‹è¯•ç”¨ä¾‹
    - ğŸ“‹ éŸ³é¢‘æ ¼å¼è½¬æ¢ç®—æ³•æ–‡æ¡£
    - ğŸ“‹ å½•éŸ³æ§åˆ¶çŠ¶æ€æœºè®¾è®¡
    - ğŸ“‹ éŸ³é¢‘è´¨é‡æµ‹è¯•æ ‡å‡†

    **è¯¦ç»†ä»»åŠ¡å†…å®¹ï¼š**
    - åˆ›å»ºmic_driver.hå®šä¹‰éº¦å…‹é£é…ç½®å’Œæ§åˆ¶æ¥å£
    - å®ç°mic_driver.cåŒ…å«INMP441åˆå§‹åŒ–å’Œæ§åˆ¶å‡½æ•°
    - é…ç½®I2Sæ¥æ”¶æ¨¡å¼ï¼šGPIO18(DIN)ã€GPIO4(BCLK)ã€GPIO5(WS)
    - å®ç°å½•éŸ³æ§åˆ¶ï¼šmic_start_recording()ã€mic_stop_recording()
    - æ·»åŠ éŸ³é¢‘æ•°æ®é¢„å¤„ç†ï¼šå¢ç›Šæ§åˆ¶ã€å™ªéŸ³æŠ‘åˆ¶
    - å®ç°å½•éŸ³çŠ¶æ€ç›‘æ§å’ŒéŸ³é‡æ£€æµ‹
    - åˆ›å»ºå½•éŸ³æ•°æ®çš„WebSocketä¸Šä¼ æ¥å£

    **éªŒæ”¶æ ‡å‡†ï¼š**
    - éº¦å…‹é£èƒ½å¤Ÿæ­£å¸¸é‡‡é›†16kHz/16bitéŸ³é¢‘æ•°æ®
    - å½•éŸ³åŠŸèƒ½å“åº”æ—¶é—´<100msï¼Œåœæ­¢å½•éŸ³ç«‹å³ç”Ÿæ•ˆ
    - éŸ³é¢‘è´¨é‡æ¸…æ™°ï¼Œä¿¡å™ªæ¯”â‰¥60dB
    - å½•éŸ³è¿‡ç¨‹ä¸­LCDæ˜¾ç¤ºå®æ—¶éŸ³é‡æŒ‡ç¤º
    - å½•éŸ³æ•°æ®èƒ½å¤Ÿæ­£ç¡®æ ¼å¼åŒ–å¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨
    - éº¦å…‹é£æ•…éšœæ—¶èƒ½å¤Ÿæ£€æµ‹å¹¶æç¤ºç”¨æˆ·

  - [ ] 3.3 å®ç°MAX98357Aæ‰¬å£°å™¨é©±åŠ¨
    - ç¼–å†™åŠŸæ”¾æ¨¡å—åˆå§‹åŒ–å’Œé…ç½®ä»£ç 
    - å®ç°éŸ³é¢‘æ’­æ”¾åŠŸèƒ½å’ŒéŸ³é‡æ§åˆ¶
    - æ·»åŠ æ’­æ”¾é˜Ÿåˆ—ç®¡ç†å’Œä¼˜å…ˆçº§æ§åˆ¶
    - åˆ›å»ºæ’­æ”¾çŠ¶æ€ç›‘æ§å’Œé”™è¯¯æ¢å¤
    - _éœ€æ±‚: 5.1, 5.2, 5.3, 5.4_

    **å¼€å‘å‰ææ¡ä»¶ï¼š**
    - âœ… ä»»åŠ¡3.1 I2Sé©±åŠ¨åŸºç¡€æ¡†æ¶å·²å®Œæˆ
    - âœ… MAX98357AåŠŸæ”¾æ¨¡å—å·²æ­£ç¡®è¿æ¥å¹¶æµ‹è¯•
    - âœ… 8Î©/3Wæ‰¬å£°å™¨å·²è¿æ¥åˆ°åŠŸæ”¾è¾“å‡º
    - âœ… éŸ³é¢‘æµ‹è¯•æ–‡ä»¶ï¼ˆWAV/PCMæ ¼å¼ï¼‰

    **å¿…éœ€å‡†å¤‡ææ–™ï¼š**
    - ğŸ“‹ MAX98357Aè¯¦ç»†æŠ€æœ¯è§„æ ¼ä¹¦
    - ğŸ“‹ éŸ³é¢‘æ’­æ”¾æµ‹è¯•ç”¨ä¾‹
    - ğŸ“‹ éŸ³é‡æ§åˆ¶ç®—æ³•æ–‡æ¡£
    - ğŸ“‹ æ’­æ”¾é˜Ÿåˆ—è®¾è®¡æ–¹æ¡ˆ
    - ğŸ“‹ éŸ³é¢‘æ ¼å¼æ”¯æŒåˆ—è¡¨

    **è¯¦ç»†ä»»åŠ¡å†…å®¹ï¼š**
    - åˆ›å»ºspeaker_driver.hå®šä¹‰æ‰¬å£°å™¨é…ç½®å’Œæ’­æ”¾æ¥å£
    - å®ç°speaker_driver.cåŒ…å«MAX98357Aåˆå§‹åŒ–å’Œæ’­æ”¾å‡½æ•°
    - é…ç½®I2Så‘é€æ¨¡å¼ï¼šGPIO19(DOUT)ã€GPIO4(BCLK)ã€GPIO5(WS)
    - å®ç°éŸ³é‡æ§åˆ¶ï¼š256çº§æ•°å­—éŸ³é‡è°ƒèŠ‚
    - æ·»åŠ æ’­æ”¾é˜Ÿåˆ—ï¼šæ”¯æŒå¤šéŸ³é¢‘æ–‡ä»¶æ’é˜Ÿæ’­æ”¾
    - å®ç°æ’­æ”¾ä¼˜å…ˆçº§ï¼šç³»ç»Ÿæç¤ºéŸ³>è¯­éŸ³å›å¤>èƒŒæ™¯éŸ³ä¹
    - åˆ›å»ºæ’­æ”¾çŠ¶æ€ç›‘æ§å’Œé”™è¯¯æ¢å¤æœºåˆ¶

    **éªŒæ”¶æ ‡å‡†ï¼š**
    - æ‰¬å£°å™¨èƒ½å¤Ÿæ­£å¸¸æ’­æ”¾16kHz/16bitéŸ³é¢‘æ•°æ®
    - éŸ³é‡è°ƒèŠ‚å¹³æ»‘ï¼Œ256çº§è°ƒèŠ‚æ— æ˜æ˜¾è·³è·ƒ
    - æ’­æ”¾é˜Ÿåˆ—å·¥ä½œæ­£å¸¸ï¼Œæ”¯æŒæ’­æ”¾/æš‚åœ/åœæ­¢æ§åˆ¶
    - éŸ³é¢‘æ’­æ”¾å»¶è¿Ÿ<50msï¼ŒéŸ³è´¨æ¸…æ™°æ— å¤±çœŸ
    - æ’­æ”¾è¿‡ç¨‹ä¸­LCDæ˜¾ç¤ºéŸ³é‡æ¡å’Œæ’­æ”¾çŠ¶æ€
    - æ‰¬å£°å™¨æ•…éšœæ—¶èƒ½å¤Ÿæ£€æµ‹å¹¶æç¤ºç”¨æˆ·

  - [ ] 3.4 å®ç°éŸ³é¢‘ç³»ç»Ÿé›†æˆæµ‹è¯•
    - ç¼–å†™éŸ³é¢‘é‡‡é›†æ’­æ”¾çš„ç«¯åˆ°ç«¯æµ‹è¯•
    - éªŒè¯éŸ³é¢‘å»¶è¿Ÿå’ŒåŒæ­¥æ€§èƒ½
    - æµ‹è¯•éŸ³é¢‘è´¨é‡å’Œå™ªéŸ³æŠ‘åˆ¶æ•ˆæœ
    - _éœ€æ±‚: 4.3, 4.7, 5.7_

    **å¼€å‘å‰ææ¡ä»¶ï¼š**
    - âœ… ä»»åŠ¡3.2 INMP441éº¦å…‹é£é©±åŠ¨å·²å®Œæˆ
    - âœ… ä»»åŠ¡3.3 MAX98357Aæ‰¬å£°å™¨é©±åŠ¨å·²å®Œæˆ
    - âœ… éŸ³é¢‘æµ‹è¯•è®¾å¤‡ï¼ˆä¿¡å·å‘ç”Ÿå™¨ã€é¢‘è°±åˆ†æä»ªï¼‰
    - âœ… æ ‡å‡†æµ‹è¯•éŸ³é¢‘æ–‡ä»¶

    **å¿…éœ€å‡†å¤‡ææ–™ï¼š**
    - ğŸ“‹ éŸ³é¢‘æµ‹è¯•æ ‡å‡†å’Œè§„èŒƒ
    - ğŸ“‹ ç«¯åˆ°ç«¯æµ‹è¯•ç”¨ä¾‹è®¾è®¡
    - ğŸ“‹ éŸ³é¢‘è´¨é‡è¯„ä¼°æ ‡å‡†
    - ğŸ“‹ æ€§èƒ½åŸºå‡†æµ‹è¯•æ–¹æ¡ˆ
    - ğŸ“‹ é•¿æœŸç¨³å®šæ€§æµ‹è¯•è®¡åˆ’

    **è¯¦ç»†ä»»åŠ¡å†…å®¹ï¼š**
    - åˆ›å»ºaudio_test.cåŒ…å«éŸ³é¢‘ç³»ç»Ÿæµ‹è¯•ç”¨ä¾‹
    - å®ç°å›éŸ³æµ‹è¯•ï¼šå½•éŸ³åç«‹å³æ’­æ”¾ï¼Œæµ‹è¯•å»¶è¿Ÿ
    - æ·»åŠ éŸ³é¢‘è´¨é‡æµ‹è¯•ï¼šé¢‘ç‡å“åº”ã€å¤±çœŸåº¦æµ‹é‡
    - å®ç°é•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯•ï¼šè¿ç»­å½•éŸ³æ’­æ”¾24å°æ—¶
    - æ·»åŠ å¼‚å¸¸æƒ…å†µæµ‹è¯•ï¼šI2Sé”™è¯¯ã€ç¼“å†²åŒºæº¢å‡ºç­‰
    - åˆ›å»ºéŸ³é¢‘æ€§èƒ½æŠ¥å‘Šå’Œä¼˜åŒ–å»ºè®®
    - å®ç°è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬å’Œç»“æœåˆ†æ

    **éªŒæ”¶æ ‡å‡†ï¼š**
    - ç«¯åˆ°ç«¯éŸ³é¢‘å»¶è¿Ÿ<100msï¼ˆå½•éŸ³åˆ°æ’­æ”¾ï¼‰
    - éŸ³é¢‘è´¨é‡æµ‹è¯•é€šè¿‡ï¼šTHD+N<1%ï¼Œé¢‘å“20Hz-8kHz
    - é•¿æ—¶é—´æµ‹è¯•ç¨³å®šï¼š24å°æ—¶æ— éŸ³é¢‘ä¸­æ–­æˆ–è´¨é‡ä¸‹é™
    - å¼‚å¸¸æ¢å¤æµ‹è¯•é€šè¿‡ï¼šèƒ½å¤Ÿä»å„ç§é”™è¯¯çŠ¶æ€è‡ªåŠ¨æ¢å¤
    - æµ‹è¯•æŠ¥å‘Šå®Œæ•´ï¼šåŒ…å«æ€§èƒ½æŒ‡æ ‡å’Œä¼˜åŒ–å»ºè®®
    - è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–ç‡â‰¥90%